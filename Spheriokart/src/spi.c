#include "lib/spidrv.h"
#include "spi.h"

#define DEBUG 0

SPIDRV_HandleData_t handleData;
SPIDRV_Handle_t handle = &handleData;

// a pixel is 4 bits (a half byte)
// a sprite is 16x16 pixels


#define NUM_SPRITE_IDS 1
#define SPI_CMD_DRAW_SPRITE 1
#define SPI_CMD_SEND_SPRITE 2

sprite_data_t sprite_sphere = {
	.sprite_id = 0,
	.data = {
			0xff, 0xff, 0xff, 0x88, 0x88, 0xff, 0xff, 0xff,
			0xff, 0xff, 0x88, 0x88, 0x88, 0x88, 0xff, 0xff,
			0xff, 0xf8, 0x88, 0x88, 0x88, 0x88, 0x8f, 0xff,
			0xff, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0xff,
			0xf8, 0x88, 0x66, 0x88, 0x88, 0x66, 0x88, 0x8f,
			0xf8, 0x86, 0x66, 0x68, 0x86, 0x66, 0x68, 0x8f,
			0x88, 0x86, 0x66, 0x68, 0x86, 0x66, 0x68, 0x88,
			0x88, 0x88, 0x66, 0x88, 0x88, 0x66, 0x88, 0x88,
			0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,
			0x88, 0x88, 0x66, 0x66, 0x66, 0x66, 0x88, 0x88,
			0xf8, 0x88, 0x86, 0x66, 0x66, 0x68, 0x88, 0x8f,
			0xf8, 0x88, 0x88, 0x66, 0x66, 0x88, 0x88, 0x8f,
			0xff, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0xff,
			0xff, 0xf8, 0x88, 0x88, 0x88, 0x88, 0x8f, 0xff,
			0xff, 0xff, 0x88, 0x88, 0x88, 0x88, 0xff, 0xff,
			0xff, 0xff, 0xff, 0x88, 0x88, 0xff, 0xff, 0xff,
		}
};

sprite_data_t sprite_bush_1 = {
	.sprite_id = 8,
	.data = {
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xf6, 0x6f, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0x66, 0x6a, 0xa6, 0x6f, 0xff, 0xff, 
			0xff, 0xf6, 0xba, 0xaa, 0x99, 0xa6, 0xff, 0xff, 
			0xff, 0xf6, 0xa9, 0xbb, 0xaa, 0xaa, 0x6f, 0xff, 
			0xff, 0x6b, 0xaa, 0xa9, 0x9a, 0x99, 0xa6, 0x6f, 
			0xf6, 0xaa, 0x99, 0x99, 0xaa, 0xa9, 0xaa, 0x96, 
			0x6b, 0xbb, 0xaa, 0xaa, 0xab, 0xba, 0xba, 0xa6, 
			0x6a, 0xa9, 0x9a, 0xa9, 0x99, 0x9a, 0xba, 0x6f, 
			0xf6, 0xaa, 0xab, 0xba, 0xaa, 0xa9, 0xab, 0x6f, 
			0xff, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0xff, 
		}
};

sprite_data_t sprite_bush_2 = {
	.sprite_id = 9,
	.data = {
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0x66, 0x6f, 0xff, 0xff, 0xff, 0xff, 
			0xff, 0xf6, 0x9b, 0xb6, 0x66, 0x6f, 0xff, 0xff, 
			0xff, 0x69, 0xaa, 0xab, 0x99, 0xa6, 0xff, 0xff, 
			0xf6, 0xbb, 0xaa, 0xaa, 0xba, 0x9a, 0x6f, 0xff, 
			0xf6, 0xa9, 0xbb, 0xaa, 0xaa, 0xbb, 0xa6, 0xff, 
			0x6a, 0xaa, 0x99, 0x99, 0xaa, 0xa9, 0x99, 0x6f, 
			0x69, 0xaa, 0xaa, 0xaa, 0xbb, 0xaa, 0xab, 0x96, 
			0x6b, 0x9a, 0xaa, 0xa9, 0xab, 0xbb, 0xaa, 0xb6, 
			0xf6, 0xbb, 0x99, 0x9a, 0xaa, 0xaa, 0x99, 0x6f, 
			0xff, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0xff, 
		}
};

// Tree
sprite_data_t sprite_bush_3 = {
	.sprite_id = 10,
	.data = {
			0xff, 0xff, 0x66, 0x66, 0xff, 0xf6, 0x6f, 0xff, 
			0xff, 0xf6, 0xbb, 0xba, 0x66, 0x6a, 0xb6, 0xff, 
			0xff, 0x6a, 0xaa, 0xaa, 0xaa, 0xaa, 0xab, 0x6f, 
			0xf6, 0xbb, 0xa9, 0x99, 0xab, 0x99, 0x99, 0x6f, 
			0xf6, 0x99, 0xba, 0xaa, 0xb9, 0xaa, 0xaa, 0xa6, 
			0x6a, 0xaa, 0x9b, 0xaa, 0xb9, 0xaa, 0xaa, 0xb6, 
			0x6a, 0xaa, 0xa9, 0xba, 0x9a, 0xaa, 0xab, 0x6f, 
			0x6b, 0xaa, 0xaa, 0xaa, 0x9a, 0xaa, 0xab, 0x6f, 
			0xf6, 0xbb, 0x9a, 0xaa, 0xaa, 0xaa, 0xb9, 0x6f, 
			0xff, 0x66, 0x66, 0x66, 0x6a, 0x6b, 0x66, 0xff, 
			0xff, 0xff, 0xff, 0x67, 0x76, 0x76, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0x6c, 0x77, 0x6f, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0x67, 0x76, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xff, 0x67, 0x76, 0xff, 0xff, 0xff, 
			0xff, 0xff, 0xf6, 0x77, 0xc7, 0x6f, 0xff, 0xff, 
			0xff, 0xff, 0x67, 0x7c, 0x77, 0x76, 0xff, 0xff, 
		}
};


void spi_send_sprite(sprite_data_t sprite) {
	int buffer_size = 3 + SPRITE_BYTES;
	uint8_t buffer[3 + SPRITE_BYTES];
	buffer[0] = SPI_CMD_SEND_SPRITE;
	buffer[1] = sprite.sprite_id;
	for (int i = 0; i < SPRITE_BYTES; i++) {
		buffer[2 + i] = sprite.data[i];
	}
	buffer[buffer_size - 1] = 0;
	SPIDRV_MTransmitB( handle, buffer, buffer_size );
}

void spi_draw_sprite(sprite_draw_info sprite_info) {
	int buffer_size = 8;
	uint8_t buffer[8];
	buffer[0] = SPI_CMD_DRAW_SPRITE;
	buffer[1] = sprite_info.sprite_id;
	buffer[2] = sprite_info.x >> 8;
	buffer[3] = sprite_info.x & 0x00FF;
	buffer[4] = sprite_info.y >> 8;
	buffer[5] = sprite_info.y & 0x00FF;
	buffer[6] = sprite_info.scale;
	buffer[7] = 0;
	SPIDRV_MTransmitB( handle, buffer, buffer_size );
}

void spi_send_test(int i) {
	int buffer_size = 2;
	uint8_t buffer[2];
	buffer[0] = i;
	buffer[1] = 0;
	SPIDRV_MTransmitB( handle, buffer, buffer_size );
}

void spi_init(void) {
	SPIDRV_Init_t initData = SPIDRV_MASTER_USART1;
	#if !DEV
		initData.portLocation = _USART_ROUTE_LOCATION_LOC0;
	#endif
	initData.bitRate = 6000000;
	SPIDRV_Init( handle, &initData );
}

void busy_sleep(int i) {
	int c = 0;
	while (i * 1000 > c) {
		c++;
	}
}

void spi_send_sprites( void ) {
	spi_send_sprite(sprite_bush_1);
	spi_send_sprite(sprite_bush_2);
	spi_send_sprite(sprite_bush_3);
	spi_send_sprite(sprite_sphere);
}
